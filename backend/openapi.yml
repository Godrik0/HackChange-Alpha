openapi: 3.0.3
info:
  title: HackChange-Alpha
  description: |
    API для управления клиентами и расчета ML-скоринга.
  version: 1.0.0
  license:
    name: MIT
    url: https://opensource.org/licenses/MIT

servers:
  - url: http://localhost:8080
    description: Development server

tags:
  - name: clients
    description: Операции с клиентами
  - name: scoring
    description: ML-скоринг клиентов
  - name: health
    description: Проверка состояния сервиса

paths:
  /health:
    get:
      tags:
        - health
      summary: Проверка здоровья сервиса
      description: Возвращает статус работоспособности API
      operationId: healthCheck
      responses:
        '200':
          description: Сервис работает
          content:
            application/json:
              schema:
                type: object
                properties:
                  status:
                    type: string
                    example: ok
              example:
                status: ok

  /api/clients:
    get:
      tags:
        - clients
      summary: Список клиентов
      description: Возвращает список всех клиентов с пагинацией (offset-based)
      operationId: listClients
      parameters:
        - name: limit
          in: query
          description: Количество записей (по умолчанию 100, макс 1000)
          schema:
            type: integer
            default: 100
            maximum: 1000
            minimum: 1
          example: 100
        - name: offset
          in: query
          description: Смещение (по умолчанию 0)
          schema:
            type: integer
            default: 0
            minimum: 0
          example: 0
      responses:
        '200':
          description: Список клиентов
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/ClientResponse'
        '400':
          $ref: '#/components/responses/BadRequest'
        '500':
          $ref: '#/components/responses/InternalError'
    
    post:
      tags:
        - clients
      summary: Создать нового клиента
      description: Создает нового клиента с указанными данными
      operationId: createClient
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateClientRequest'
            examples:
              basic:
                summary: Базовый пример
                value:
                  first_name: Иван
                  last_name: Иванов
                  birth_date: "15-01-1990"
              withData:
                summary: С дополнительными данными
                value:
                  first_name: Мария
                  last_name: Петрова
                  birth_date: "20-03-1985"
                  features:
                    income: 50000
                    employment_years: 5
                    credit_history: good
      responses:
        '201':
          description: Клиент успешно создан
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ClientResponse'
        '400':
          $ref: '#/components/responses/BadRequest'
        '500':
          $ref: '#/components/responses/InternalError'

  /api/clients/{id}:
    get:
      tags:
        - clients
      summary: Получить клиента по ID
      description: Возвращает информацию о клиенте по его идентификатору
      operationId: getClient
      parameters:
        - $ref: '#/components/parameters/ClientId'
      responses:
        '200':
          description: Клиент найден
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ClientResponse'
        '400':
          $ref: '#/components/responses/BadRequest'
        '404':
          $ref: '#/components/responses/NotFound'
        '500':
          $ref: '#/components/responses/InternalError'

    put:
      tags:
        - clients
      summary: Обновить клиента
      description: Обновляет данные существующего клиента
      operationId: updateClient
      parameters:
        - $ref: '#/components/parameters/ClientId'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/UpdateClientRequest'
            examples:
              partial:
                summary: Частичное обновление
                value:
                  first_name: Иван
                  last_name: Сидоров
              full:
                summary: Полное обновление
                value:
                  first_name: Петр
                  last_name: Петров
                  birth_date: "10-05-1988"
                  features:
                    income: 75000
                    employment_years: 8
      responses:
        '200':
          description: Клиент успешно обновлен
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ClientResponse'
        '400':
          $ref: '#/components/responses/BadRequest'
        '404':
          $ref: '#/components/responses/NotFound'
        '500':
          $ref: '#/components/responses/InternalError'

    delete:
      tags:
        - clients
      summary: Удалить клиента
      description: Удаляет клиента из базы данных
      operationId: deleteClient
      parameters:
        - $ref: '#/components/parameters/ClientId'
      responses:
        '200':
          description: Клиент успешно удален
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SuccessResponse'
              example:
                message: client deleted successfully
        '400':
          $ref: '#/components/responses/BadRequest'
        '404':
          $ref: '#/components/responses/NotFound'
        '500':
          $ref: '#/components/responses/InternalError'

  /api/clients/search:
    get:
      tags:
        - clients
      summary: Поиск клиентов
      description: |
        Поиск клиентов по заданным параметрам.
        Необходимо указать хотя бы один параметр поиска.
        Поиск по имени и фамилии регистронезависимый и поддерживает частичное совпадение.
      operationId: searchClients
      parameters:
        - name: first_name
          in: query
          description: Имя клиента (частичное совпадение)
          schema:
            type: string
            minLength: 1
          example: Иван
        - name: last_name
          in: query
          description: Фамилия клиента (частичное совпадение)
          schema:
            type: string
            minLength: 1
          example: Иванов
        - name: middle_name
          in: query
          description: Отчество клиента (частичное совпадение)
          schema:
            type: string
            minLength: 1
          example: Иванович
        - name: birth_date
          in: query
          description: Дата рождения (точное совпадение, формат DD-MM-YYYY)
          schema:
            type: string
          example: "15-01-1990"
      responses:
        '200':
          description: Результаты поиска
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/ClientSearchResponse'
              examples:
                found:
                  summary: Найдены клиенты
                  value:
                    - id: 1
                      first_name: Иван
                      last_name: Иванов
                      birth_date: "15-01-1990"
                    - id: 2
                      first_name: Иван
                      last_name: Петров
                      birth_date: "20-03-1992"
                empty:
                  summary: Клиенты не найдены
                  value: []
        '400':
          description: Не указаны параметры поиска
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              example:
                error: at least one search parameter is required
        '500':
          $ref: '#/components/responses/InternalError'

  /api/clients/import:
    post:
      tags:
        - clients
      summary: Импорт клиентов из CSV
      description: |
        Загружает клиентов из CSV файла. 
        
        **Формат CSV:**
        - Обязательные колонки: `first_name`, `last_name`, `birth_date`
        - Опциональная колонка: `middle_name`
        - Все остальные колонки сохраняются как ML features
        
        **Форматы даты:** DD-MM-YYYY, YYYY-MM-DD, DD/MM/YYYY, YYYY/MM/DD
        
        **ML Features:** Модель требует 221 фичу. При расчете скоринга отсутствующие фичи автоматически заполняются нулями.
        
        **Примеры CSV:**
        - Минимальный: `first_name,last_name,birth_date`
        - С ключевыми фичами: `first_name,last_name,birth_date,salary_6to12m_avg,age,pil`
        - Полный: все 221 фича (см. example_full_features.csv)
      operationId: importClientsCSV
      requestBody:
        required: true
        content:
          multipart/form-data:
            schema:
              type: object
              required:
                - file
              properties:
                file:
                  type: string
                  format: binary
                  description: CSV файл с данными клиентов (макс 10MB)
            examples:
              minimal:
                summary: Минимальный CSV
                value: |
                  first_name,last_name,birth_date
                  Иван,Петров,15-05-1985
                  Мария,Иванова,1990-08-22
              withFeatures:
                summary: CSV с ML фичами
                value: |
                  first_name,last_name,birth_date,salary_6to12m_avg,age,pil,gender
                  Иван,Петров,15-05-1985,85000.50,38,2,Мужской
                  Мария,Иванова,1990-08-22,75000.00,33,1,Женский
      responses:
        '200':
          description: Результат импорта
          content:
            application/json:
              schema:
                type: object
                required:
                  - success_count
                  - failure_count
                  - total
                properties:
                  success_count:
                    type: integer
                    description: Количество успешно импортированных клиентов
                    example: 98
                  failure_count:
                    type: integer
                    description: Количество неудачных записей
                    example: 2
                  total:
                    type: integer
                    description: Общее количество обработанных записей
                    example: 100
                  errors:
                    type: array
                    items:
                      type: string
                    description: Список ошибок (макс 20, остальные обрезаются)
                    example:
                      - "Line 15: birth_date is required"
                      - "Line 23: invalid birth_date format: 1990-13-45 (expected DD-MM-YYYY or YYYY-MM-DD)"
              examples:
                success:
                  summary: Успешный импорт
                  value:
                    success_count: 100
                    failure_count: 0
                    total: 100
                partial:
                  summary: Частичный успех
                  value:
                    success_count: 95
                    failure_count: 5
                    total: 100
                    errors:
                      - "Line 12: first_name is required"
                      - "Line 34: invalid birth_date format: 32-01-1990 (expected DD-MM-YYYY or YYYY-MM-DD)"
                      - "Line 67: last_name is required"
                      - "Line 89: birth_date is required"
                      - "Line 91: column count mismatch"
        '400':
          description: Ошибка в запросе
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              examples:
                noFile:
                  summary: Файл не предоставлен
                  value:
                    error: file is required
                tooLarge:
                  summary: Файл слишком большой
                  value:
                    error: file too large or invalid form data
                invalidFormat:
                  summary: Неверный формат CSV
                  value:
                    error: invalid CSV format
        '500':
          $ref: '#/components/responses/InternalError'

  /api/clients/{id}/scoring:
    get:
      tags:
        - scoring
      summary: Рассчитать ML-скоринг клиента
      description: |
        Выполняет расчет ML-скоринга для указанного клиента.
        Возвращает оценку (score), кредитный лимит, рекомендации и факторы.
        
        **Автоматическое дополнение фич:**
        Модель требует ровно 221 фичу. Если у клиента меньше фич, недостающие автоматически заполняются нулевыми значениями.
        
        **Список 221 фичи включает:**
        - Финансовые показатели: turn_cur_cr_avg_act_v2, salary_6to12m_avg, incomeValue
        - Кредитная история: hdb_bki_total_max_limit, pil, loan_cnt
        - Банковские операции: avg_cur_cr_turn, turn_cur_db_sum_v2
        - Демографические данные: age, gender, region
        - И 210+ других признаков
      operationId: calculateScoring
      parameters:
        - $ref: '#/components/parameters/ClientId'
      responses:
        '200':
          description: Скоринг успешно рассчитан
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ScoringResponse'
              examples:
                positive:
                  summary: Положительная оценка
                  value:
                    id: 1
                    first_name: Иван
                    last_name: Иванов
                    middle_name: Иванович
                    birth_date: "15-01-1990"
                    income: 50000
                    predict_income: 52000.50
                    credit_limit: 150000
                    max_credit_limit: 200000
                    positive_factors:
                      - Стабильный доход
                      - Хорошая кредитная история
                    negative_factors:
                      - Отсутствие залогового имущества
                    recommendations:
                      - Рекомендуется одобрение кредита
                      - Можно увеличить лимит при предоставлении поручителя
        '400':
          $ref: '#/components/responses/BadRequest'
        '404':
          $ref: '#/components/responses/NotFound'
        '500':
          $ref: '#/components/responses/InternalError'

components:
  parameters:
    ClientId:
      name: id
      in: path
      required: true
      description: Уникальный идентификатор клиента
      schema:
        type: integer
        format: int64
        minimum: 1
      example: 1

  schemas:
    CreateClientRequest:
      type: object
      required:
        - first_name
        - last_name
        - birth_date
      properties:
        first_name:
          type: string
          minLength: 1
          maxLength: 100
          description: Имя клиента
          example: Иван
        last_name:
          type: string
          minLength: 1
          maxLength: 100
          description: Фамилия клиента
          example: Иванов
        middle_name:
          type: string
          maxLength: 100
          description: Отчество клиента (опционально)
          example: Иванович
        birth_date:
          type: string
          description: Дата рождения (DD-MM-YYYY или ISO)
          example: "15-01-1990"
        features:
          type: object
          additionalProperties: true
          description: Признаки для ML-модели (произвольная структура)
          example:
            income: 50000
            employment_years: 5
            credit_history: good
            has_car: true

    UpdateClientRequest:
      type: object
      properties:
        first_name:
          type: string
          minLength: 1
          maxLength: 100
          description: Имя клиента
          example: Иван
        last_name:
          type: string
          minLength: 1
          maxLength: 100
          description: Фамилия клиента
          example: Петров
        middle_name:
          type: string
          maxLength: 100
          description: Отчество клиента
          example: Петрович
        birth_date:
          type: string
          description: Дата рождения (DD-MM-YYYY или ISO)
          example: "15-01-1990"
        features:
          type: object
          additionalProperties: true
          description: Признаки для ML-модели
          example:
            income: 60000
            employment_years: 6

    ClientResponse:
      type: object
      required:
        - id
        - first_name
        - last_name
        - birth_date
      properties:
        id:
          type: integer
          format: int64
          description: Уникальный идентификатор клиента
          example: 1
        first_name:
          type: string
          description: Имя клиента
          example: Иван
        last_name:
          type: string
          description: Фамилия клиента
          example: Иванов
        middle_name:
          type: string
          description: Отчество клиента
          example: Иванович
        birth_date:
          type: string
          description: Дата рождения в формате DD-MM-YYYY или ISO
          example: "15-01-1990"
        income:
          type: integer
          description: Доход клиента
          example: 50000

    ClientSearchResponse:
      type: object
      required:
        - id
        - first_name
        - last_name
        - birth_date
      properties:
        id:
          type: integer
          format: int64
          description: Уникальный идентификатор клиента
          example: 1
        first_name:
          type: string
          description: Имя клиента
          example: Иван
        last_name:
          type: string
          description: Фамилия клиента
          example: Иванов
        middle_name:
          type: string
          description: Отчество клиента
          example: Иванович
        birth_date:
          type: string
          description: Дата рождения в формате DD-MM-YYYY или ISO
          example: "15-01-1990"
        income:
          type: integer
          description: Доход клиента
          example: 50000

    ScoringResponse:
      type: object
      required:
        - id
        - first_name
        - last_name
        - birth_date
        - score
      properties:
        id:
          type: integer
          format: int64
          description: Уникальный идентификатор клиента
          example: 1
        first_name:
          type: string
          description: Имя клиента
          example: Иван
        last_name:
          type: string
          description: Фамилия клиента
          example: Иванов
        middle_name:
          type: string
          description: Отчество клиента
          example: Иванович
        birth_date:
          type: string
          description: Дата рождения
          example: "15-01-1990"
        income:
          type: integer
          description: Доход клиента
          example: 50000
        predict_income:
          type: number
          format: double
          description: Предсказанный доход клиента
          example: 52000.50
        credit_limit:
          type: number
          format: double
          description: Рекомендуемый кредитный лимит
          example: 150000.50
        max_credit_limit:
          type: number
          format: double
          description: Максимальный возможный кредитный лимит
          example: 200000.00
        positive_factors:
          type: array
          items:
            type: string
          description: Положительные факторы
          example:
            - Стабильный доход
            - Хорошая кредитная история
        negative_factors:
          type: array
          items:
            type: string
          description: Негативные факторы
          example:
            - Отсутствие залогового имущества
        recommendations:
          type: array
          items:
            type: string
          description: Рекомендации на основе скоринга
          example:
            - Рекомендуется одобрение кредита
            - Можно увеличить лимит при предоставлении поручителя

    ErrorResponse:
      type: object
      required:
        - error
      properties:
        error:
          type: string
          description: Описание ошибки
          example: client not found
        message:
          type: string
          description: Дополнительное сообщение об ошибке
          example: Клиент с указанным ID не найден в базе данных
        code:
          type: string
          description: Код ошибки
          example: NOT_FOUND

    SuccessResponse:
      type: object
      properties:
        message:
          type: string
          description: Сообщение об успешной операции
          example: client deleted successfully
        data:
          type: object
          additionalProperties: true
          description: Дополнительные данные

  responses:
    BadRequest:
      description: Некорректный запрос
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ErrorResponse'
          examples:
            invalidId:
              summary: Некорректный ID
              value:
                error: invalid client ID
            invalidBody:
              summary: Некорректное тело запроса
              value:
                error: invalid request body
            missingParams:
              summary: Отсутствуют параметры
              value:
                error: at least one search parameter is required

    NotFound:
      description: Ресурс не найден
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ErrorResponse'
          example:
            error: client not found

    InternalError:
      description: Внутренняя ошибка сервера
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ErrorResponse'
          examples:
            database:
              summary: Ошибка базы данных
              value:
                error: failed to get client
                message: Database connection error
            mlService:
              summary: Ошибка ML сервиса
              value:
                error: failed to calculate scoring
                message: ML service is unavailable
            general:
              summary: Общая ошибка
              value:
                error: internal error